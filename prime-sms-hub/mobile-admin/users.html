<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#FF6B35">
    <title>Users - Prime SMS Hub Admin</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="../mobile/css/mobile.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- HEADER -->
    <header class="mobile-header">
        <div class="mobile-header-title">User Management</div>
        <button class="mobile-header-action" id="logoutBtn" onclick="handleLogout()">ðŸšª</button>
    </header>

    <!-- MAIN CONTENT -->
    <main class="mobile-main">
        <!-- SEARCH & FILTER -->
        <div class="search-box-container">
            <input type="text" class="search-box" id="userSearch" placeholder="Search users by email...">
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterUsers('all')">All</button>
                <button class="filter-btn" onclick="filterUsers('active')">Active</button>
                <button class="filter-btn" onclick="filterUsers('suspended')">Suspended</button>
            </div>
        </div>

        <!-- USERS LIST -->
        <div id="usersContainer" class="users-list"></div>
    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="mobile-nav">
        <a href="index.html" class="nav-item">
            <span class="nav-icon">ðŸ“Š</span>
            <span>Stats</span>
        </a>
        <a href="users.html" class="nav-item active">
            <span class="nav-icon">ðŸ‘¥</span>
            <span>Users</span>
        </a>
        <a href="payments.html" class="nav-item">
            <span class="nav-icon">ðŸ’°</span>
            <span>Payments</span>
        </a>
        <a href="support.html" class="nav-item">
            <span class="nav-icon">ðŸ’¬</span>
            <span>Support</span>
        </a>
    </nav>

    <!-- ACTION MODAL -->
    <div id="actionModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Action</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody" class="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmActionBtn" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="../mobile/js/mock-data.js"></script>
    <script src="../mobile/js/api.js"></script>
    <script src="js/admin.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script>
        let allUsers = [];
        let filteredUsers = [];
        let currentFilter = 'all';
        let currentAction = null;

        async function loadUsers() {
            showLoading('usersContainer', 'Loading users...');
            let users = await api.getUsers();
            if (!users) {
                users = getMockData('admin.users');
            }
            allUsers = users || [];
            filterUsers('all');
        }

        function filterUsers(status) {
            currentFilter = status;
            if (status === 'all') {
                filteredUsers = allUsers;
            } else {
                filteredUsers = allUsers.filter(u => u.status === status);
            }
            renderUsers();
            updateFilterButtons();
        }

        function searchUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase();
            if (!query) {
                filterUsers(currentFilter);
                return;
            }
            filteredUsers = allUsers.filter(u =>
                (u.email && u.email.toLowerCase().includes(query)) ||
                (u.name && u.name.toLowerCase().includes(query))
            );
            renderUsers();
        }

        function renderUsers() {
            const container = document.getElementById('usersContainer');
            if (filteredUsers.length === 0) {
                container.innerHTML = '<div class="empty-state">No users found</div>';
                return;
            }
            container.innerHTML = filteredUsers.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-name">${user.name || user.email}</div>
                        <div class="user-email">${user.email}</div>
                        <div class="user-meta">Balance: â‚¦${(user.balance || 0).toFixed(2)} | Joined: ${user.dateJoined || 'N/A'}</div>
                    </div>
                    <div class="user-status">
                        <span class="status-badge status-${user.status}">${user.status}</span>
                    </div>
                    <div class="user-actions">
                        ${user.status === 'active' ? `<button class="btn btn-sm btn-danger" onclick="openActionModal('suspend', ${user.id})">Suspend</button>` : ''}
                        ${user.status === 'suspended' ? `<button class="btn btn-sm btn-success" onclick="openActionModal('activate', ${user.id})">Activate</button>` : ''}
                        <button class="btn btn-sm btn-secondary" onclick="openActionModal('delete', ${user.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function updateFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(currentFilter));
            });
        }

        function openActionModal(action, userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            currentAction = { action, userId, user };
            const modal = document.getElementById('actionModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            const confirmBtn = document.getElementById('confirmActionBtn');
            
            if (action === 'suspend') {
                title.textContent = 'Suspend User';
                body.innerHTML = `<p>Are you sure you want to suspend <strong>${user.email}</strong>?</p><p class="text-muted">They will not be able to login or access services.</p>`;
                confirmBtn.textContent = 'Suspend';
                confirmBtn.className = 'btn btn-danger';
            } else if (action === 'activate') {
                title.textContent = 'Activate User';
                body.innerHTML = `<p>Are you sure you want to activate <strong>${user.email}</strong>?</p>`;
                confirmBtn.textContent = 'Activate';
                confirmBtn.className = 'btn btn-success';
            } else if (action === 'delete') {
                title.textContent = 'Delete User';
                body.innerHTML = `<p>Are you sure you want to delete <strong>${user.email}</strong>?</p><p class="text-danger">This action cannot be undone.</p>`;
                confirmBtn.textContent = 'Delete';
                confirmBtn.className = 'btn btn-danger';
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('actionModal').classList.add('hidden');
            currentAction = null;
        }

        async function confirmAction() {
            if (!currentAction) return;
            showLoading('modalBody', 'Processing...');
            
            const { action, userId, user } = currentAction;
            let success = false;
            
            if (action === 'suspend') {
                success = await api.updateUser(userId, { status: 'suspended' });
            } else if (action === 'activate') {
                success = await api.updateUser(userId, { status: 'active' });
            } else if (action === 'delete') {
                success = await api.deleteUser(userId);
            }
            
            if (success) {
                showNotification(`User ${action}d successfully`);
                closeModal();
                loadUsers();
            } else {
                showNotification('Action failed', 'error');
                closeModal();
            }
        }

        function showNotification(msg, type = 'success') {
            const notif = document.createElement('div');
            notif.className = `notification notification-${type}`;
            notif.textContent = msg;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function showLoading(containerId, msg = 'Loading...') {
            document.getElementById(containerId).innerHTML = `<div class="loading">${msg}</div>`;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>
