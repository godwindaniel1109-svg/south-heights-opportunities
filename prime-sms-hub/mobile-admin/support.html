<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#FF6B35">
    <title>Support - Prime SMS Hub Admin</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="../mobile/css/mobile.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- HEADER -->
    <header class="mobile-header">
        <div class="mobile-header-title">Support Management</div>
        <button class="mobile-header-action" id="logoutBtn" onclick="handleLogout()">ðŸšª</button>
    </header>

    <!-- MAIN CONTENT -->
    <main class="mobile-main">
        <!-- SEARCH -->
        <input type="text" class="search-box" id="supportSearch" placeholder="Search conversations..." onkeyup="searchConversations()">

        <!-- CONVERSATIONS LIST -->
        <div id="conversationsContainer" class="conversations-list"></div>
    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="mobile-nav">
        <a href="index.html" class="nav-item">
            <span class="nav-icon">ðŸ“Š</span>
            <span>Stats</span>
        </a>
        <a href="users.html" class="nav-item">
            <span class="nav-icon">ðŸ‘¥</span>
            <span>Users</span>
        </a>
        <a href="payments.html" class="nav-item">
            <span class="nav-icon">ðŸ’°</span>
            <span>Payments</span>
        </a>
        <a href="support.html" class="nav-item active">
            <span class="nav-icon">ðŸ’¬</span>
            <span>Support</span>
        </a>
    </nav>

    <!-- CONVERSATION DETAIL MODAL -->
    <div id="detailModal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalTitle">Conversation</h3>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div id="messagesContainer" class="messages-container"></div>
            <div class="modal-footer">
                <input type="text" id="replyText" class="reply-input" placeholder="Type your reply...">
                <button class="btn btn-primary" onclick="sendReply()">Send</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="../mobile/js/mock-data.js"></script>
    <script src="../mobile/js/api.js"></script>
    <script src="js/admin.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script>
        let allConversations = [];
        let filteredConversations = [];
        let selectedConversationId = null;

        async function loadConversations() {
            showLoading('conversationsContainer', 'Loading conversations...');
            let conversations = await api.getSupportConversations();
            if (!conversations) {
                conversations = getMockData('admin.support');
            }
            allConversations = conversations || [];
            filteredConversations = allConversations;
            renderConversations();
        }

        function searchConversations() {
            const query = document.getElementById('supportSearch').value.toLowerCase();
            if (!query) {
                filteredConversations = allConversations;
            } else {
                filteredConversations = allConversations.filter(c =>
                    (c.user && c.user.toLowerCase().includes(query)) ||
                    (c.subject && c.subject.toLowerCase().includes(query)) ||
                    (c.lastMessage && c.lastMessage.toLowerCase().includes(query))
                );
            }
            renderConversations();
        }

        function renderConversations() {
            const container = document.getElementById('conversationsContainer');
            if (filteredConversations.length === 0) {
                container.innerHTML = '<div class="empty-state">No conversations found</div>';
                return;
            }
            container.innerHTML = filteredConversations.map(conv => `
                <div class="conversation-item" onclick="openConversation(${conv.id})">
                    <div class="conversation-header">
                        <div class="conversation-user">${conv.user || 'Unknown'}</div>
                        <div class="conversation-date">${conv.date || new Date().toLocaleDateString()}</div>
                    </div>
                    <div class="conversation-subject">${conv.subject || 'Support Request'}</div>
                    <div class="conversation-preview">${conv.lastMessage || 'No messages'}</div>
                    ${conv.unread ? '<div class="unread-badge">New</div>' : ''}
                </div>
            `).join('');
        }

        async function openConversation(conversationId) {
            selectedConversationId = conversationId;
            const conversation = allConversations.find(c => c.id === conversationId);
            if (!conversation) return;

            const modal = document.getElementById('detailModal');
            document.getElementById('modalTitle').textContent = `${conversation.user} - ${conversation.subject}`;

            showLoading('messagesContainer', 'Loading messages...');
            let messages = await api.getSupportMessages(conversationId);
            if (!messages) {
                messages = conversation.messages || [];
            }

            renderMessages(messages);
            modal.classList.remove('hidden');
            document.getElementById('replyText').focus();
        }

        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = messages.map(msg => `
                <div class="message" style="text-align: ${msg.sender === 'admin' ? 'right' : 'left'};">
                    <div class="message-bubble" style="background-color: ${msg.sender === 'admin' ? '#FF6B35' : '#f0f0f0'}; color: ${msg.sender === 'admin' ? 'white' : 'black'};">
                        <div class="message-text">${msg.text}</div>
                        <div class="message-time" style="font-size: 0.75rem; opacity: 0.7;">${msg.timestamp || new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        async function sendReply() {
            const text = document.getElementById('replyText').value.trim();
            if (!text || !selectedConversationId) return;

            document.getElementById('replyText').value = '';
            document.getElementById('replyText').disabled = true;

            const success = await api.replySupportMessage(selectedConversationId, text);
            if (success) {
                showNotification('Reply sent');
                // Reload conversation
                await openConversation(selectedConversationId);
                loadConversations();
            } else {
                showNotification('Failed to send reply', 'error');
            }
            document.getElementById('replyText').disabled = false;
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
            selectedConversationId = null;
        }

        function showNotification(msg, type = 'success') {
            const notif = document.createElement('div');
            notif.className = `notification notification-${type}`;
            notif.textContent = msg;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function showLoading(containerId, msg = 'Loading...') {
            document.getElementById(containerId).innerHTML = `<div class="loading">${msg}</div>`;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', loadConversations);
    </script>
</body>
</html>
